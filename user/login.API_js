{"POST":"let email = param(\"email\",null);\r\nlet password = param(\"password\",null);\r\n\r\nlet sqlParams = {\r\n  \"email\": email,\r\n  \"password\": password\r\n};\r\n\r\n//check if the user exists\r\nlet findUser = db.query(\"SELECT users_id, users_email, users_password, picture_id, body_measurment_id FROM users WHERE users_email = :email\", sqlParams);\r\n\r\nif(findUser.rows === 0){\r\n  write('msg', 'Email is incorrect!');\r\n  exit();\r\n};\r\n\r\n// check if password is valid\r\nlet dbUser = findUser[0];\r\nlet dbPass = dbUser.users_password;\r\nlet passIsOk = bcrypt(password,dbPass);\r\n\r\n// if password is not ok throw error\r\nif(!passIsOk){\r\n  write('msg', 'Password is incorrect!');\r\n  exit();\r\n};\r\n\r\nlet sessionUser = {\r\n  user_id: dbUser.users_id,\r\n  user_email: dbUser.users_email,\r\n  picture_id: dbUser.picture_id,\r\n  body_measurment_id: dbUser.body_measurment_id\r\n}\r\n\r\n// create session();\r\nlet sid = session();\r\n\r\n//insert sessionUser data into session()\r\nsession('user', sessionUser);\r\n\r\nlet findUserRole = db.query(\"SELECT roles_id FROM user_roles WHERE users_id = :userId\", { \"userId\": sessionUser.user_id });\r\n\r\nif (findUserRole.rows === 0) {\r\n  write('msg', 'User role not found');\r\n  exit();\r\n}\r\n\r\nlet userRole = findUserRole[0].roles_id;\r\n\r\n\r\n// if the user is an admin or regular user\r\nif (userRole === 1) {\r\n  session('userRole', 'Admin');\r\n} else if (userRole === 2) {\r\n  session('userRole', 'User');\r\n} else {\r\n  write('msg', 'Invalid user role');\r\n  exit();\r\n}\r\n\r\nwrite('userRole', userRole);\r\nwrite('msg', 'Login successfully done');\r\nwrite('sid', sid);\r\nwrite('userInfo', sessionUser);\r\n","META":{"language":"JavaScript"}}